<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>FullCalendar Scheduler Clone events</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.css'>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar-scheduler/1.9.4/scheduler.min.css'>
    <!-- <link rel="stylesheet" href="./style.css"> -->

    <!-- jQuery UI CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/locale/ru.js"></script>


    <style>
        .highlighted-event,
        .highlighted-event.active {
            box-shadow: 0 0 0 .25rem rgba(49, 132, 253, 0.5);
            transition: box-shadow 0.3s ease;
        }

        .highlighted-event:hover {
            box-shadow: 0 0 0 .25rem rgba(49, 132, 253, 0.5);
        }

        .fc-timeline-event {
            margin: .25rem!important;
        }


        .fs-12{
            font-size: 12px;
        }

        .fs-14{
            font-size: 16px;
        }
        .fs-30{
            font-size: 30px;
        }

        .bg-white{
            background-color: white;
        }
        .ui-widget-header
            {
            border: 0px!important; 
            }

        .nahui{
            border-radius: 4px;
        }

        .fc-license-message{
            display: none;
        }

        .fc-unthemed{
            padding: 20px;
        }
        /* .fc-scroller{
            height: auto!important;
        } */
        
        .helpButton{
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            box-sizing: border-box;
            margin: 0;
                margin-left: 0px;
            height: 2.1em;
            padding: 0 .6em;
            white-space: nowrap;
            cursor: pointer;
        }
/* 
        .fc-cell-content{
           text-align: center;
        } */

        .fc-widget-header
            {
            text-align: center !important;
            }

        .fc-widget-header {
            height: 55px;
            background-color: #f4f4f4;
            }
        .fc-resource-area
        {
        width: 20%!important;
        }

        .fc-body .fc-resource-area .fc-cell-content
        {
        position: relative;
        padding-top: 8px;
        padding-bottom: 8px;
        background: #eff7ff;
        }
        .fc-timeline .fc-body .fc-scroller
        {
        z-index: 1;
        max-height: 90ch;
        }

        .ui-widget-header{
            cursor: pointer;
        }

        /* Стили для блока подсказки */
        #tooltip {
            position: absolute;
            top: 20%;
            left: 50%;
            width: auto;
            height: auto;
            z-index: 99999;
            border: 3px solid #007bff;
            border-radius: 8px;
        }

        #tooltip .ui-widget-header {
            background-color: #007bff;
            color: white;
            padding: 0.5em;
            border-radius: 3px;
            margin-top: 0px;
        }

        #tooltip .ui-widget-content {
            padding: 1em;
        }
    </style>
</head>

<body>
    <div id="calendar"></div>

    <!-- Блок подсказки -->
    <div id="tooltip" class="ui-widget-content">
        <div class="ui-widget-header">
            <div class="headbartooltip">
                <span class="me-5 fs-16"> Ваша подсказка по календарю</span>
                <span class="close-btn fs-30 " style="cursor: pointer; float: right;margin-top: -14px;">×</span>
                <span class="collapse-btn fs-30" style="cursor: pointer; float: right; margin-right: 10px;margin-top: -14px;">−</span>
            </div>
        </div>
        <div class="svernisnahyi">
            <ul class="p-3 nahui fs-12 bg-white m-0">
                <li style="list-style: none;">Click a calendar date to invoke a Bootstrap Modal Box.<br></li>
                <li style="list-style: none;">Add event title/description, start date, and end date.<br></li>
                <li style="list-style: none;">Click "Save" to save event.<br></li>
                <li style="list-style: none;">Click event again to re-open AND RE-EDIT in Bootstrap Modal Box.<br></li>
                <li style="list-style: none;">Click "x" to delete event.</li>
            </ul>
        </div>
             
    </div>

    
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
    <script src='https://code.jquery.com/ui/1.11.3/jquery-ui.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.10.2/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar-scheduler/1.9.4/scheduler.min.js'></script>

    <script>


    document.addEventListener('DOMContentLoaded', function () {



        document.querySelector('#exampleModal').addEventListener('show.bs.modal', function () {
        // Очищаем поле ввода при открытии модального окна
        document.querySelector('#inputName').value = '';
    });


  


            let calendarEvents = [
        { id: '1', resourceId: 'b', start: '2024-01-26 09:00:00', end: '2024-01-26 14:00:00', title: 'event 1' },
        { id: '2', resourceId: 'c', start: '2024-01-26 12:00:00', end: '2024-01-26 18:00:00', title: 'event 2' },
        { id: '3', resourceId: 'd', start: '2024-01-26 12:00:00', end: '2024-01-26 18:00:00', title: 'event 3' },
        { id: '4', resourceId: 'e', start: '2024-01-26 12:00:00', end: '2024-01-26 18:00:00', title: 'event 4' },
        { id: '5', resourceId: 'f', start: '2024-01-26 12:00:00', end: '2024-01-26 18:00:00', title: 'event 5' }
        ]

            let selectedStart;
            let selectedEnd;
            let selectedResource;
            let selectedEvent;

            // Обновление календаря
            function updateCalendar() {
                $("#calendar").fullCalendar("removeEvents");
                $("#calendar").fullCalendar("addEventSource", calendarEvents);
                $("#calendar").fullCalendar("rerenderEvents");
            }

            function findEventAtTimeRange(resourceId, start, end, eventIdToExclude) {
                for (let i = 0; i < calendarEvents.length; i++) {
                    const event = calendarEvents[i];

                    if (event.id !== eventIdToExclude &&
                        event.resourceId === resourceId &&
                        (
                            (moment(start).isAfter(event.start) && moment(start).isBefore(event.end)) ||
                            (moment(end).isAfter(event.start) && moment(end).isBefore(event.end)) ||
                            (moment(start).isSameOrBefore(event.start) && moment(end).isSameOrAfter(event.end))
                        )
                         )
                          {
                        return event;
                    }
                }
                return null;
            }

            function isAnOverlapEventForAuditorium(newEvent) {
                return findEventAtTimeRange(newEvent.resourceId, newEvent.start, newEvent.end, newEvent.id) !== null;
            }

            function canEventBeResized(newEvent) {
                const existingEvent = findEventAtTimeRange(newEvent.resourceId, newEvent.start, newEvent.end, newEvent.id);
                return existingEvent === null;
            }

            document.querySelector('#savebtn').addEventListener('click', function () {
                const eventNameInput = document.querySelector('#inputName').value;

                if (eventNameInput) {
                    const eventData = {
                        id: uuid.v4(),
                        title: eventNameInput,  // Установите заголовок для нового события
                        start: selectedStart.format(),
                        end: selectedEnd.format(),
                        resourceId: selectedResource ? selectedResource.id : null,
                    };

                    if (!isAnOverlapEventForAuditorium(eventData)) {
                        calendarEvents.push(eventData);
                        updateCalendar();
                        $("#calendar").fullCalendar("unselect");
                        $('#exampleModal').modal('hide');
                    } else {
                        alert('Нельзя создать событие в выбранное время и аудитории, так как уже существует перекрывающееся событие.');
                    }
                } else {
                    alert('Введите название события.');
                }
            });
 



            // Удаление события


            document.querySelector('#delete-button').addEventListener('click', function () {
                const eventIdToDelete = selectedEvent.id;
                alert(`Вы уверены, что хотите удалить событие с ID ${selectedEvent.id}?`);
                calendarEvents = calendarEvents.filter(event => event.id !== eventIdToDelete);
                updateCalendar();
                $('#delete-modal').modal('hide');
            });

   



 

            // Функция для обновления события в массиве
            function updateEventInArray(updatedEvent) {
                const index = calendarEvents.findIndex(event => event.id === updatedEvent.id);
                if (index !== -1) {
                    calendarEvents[index] = updatedEvent;
                }
            }


            // настройка календаря по-умолчанию 
            $('#calendar').fullCalendar({
                editable: true,
                droppable: true,
                allDaySlot: false,
                allDayDefault: false,
                navLinks: true,
                selectable: true,
                selectHelper: false,
                eventLimit: true,
                aspectRatio: 1.8,
                locale: 'ru', // Устанавливаем локаль на русскую
                scrollTime: '09:00',
                slotDuration: '00:15:00', // 30 минут
                minTime: '09:00:00', // Минимальное время (9 утра)
                maxTime: '22:00:00', // Максимальное время (9 вечера)

                header: {
                    left: 'today prev,next',
                    center: 'title',
                    right: 'button-toolptip', //timelineDay
                },
                defaultView: 'timelineDay',
                views: {
                    timelineThreeDays: {
                        type: 'timeline',
                        duration: { days: 3 },
                    },
                },
                resourceLabelText: 'Цеха',
                resources: [
                    { id: 'a', title: 'Цех A' },
                    { id: 'b', title: 'Цех B' },
                    { id: 'c', title: 'Цех C' },
                    { id: 'd', title: 'Цех D' },
                    { id: 'e', title: 'Цех E' },
                    { id: 'f', title: 'Цех F' },
                    { id: 'g', title: 'Цех G' },
                    { id: 'h', title: 'Цех H' },
                    { id: 'i', title: 'Цех I' },
                    
                ],


                events:calendarEvents,  // События (ивенты, запись)


                slotLabelFormat: 'H:mm', // Устанавливаем формат временной шкалы

                select: function (start, end, jsEvent, view, resource) {
                    selectedStart = start;
                    selectedEnd = end;
                    selectedResource = resource;
                    const newEvent = {
                        start: selectedStart.format(),
                        end: selectedEnd.format(),
                        resourceId: selectedResource ? selectedResource.id : null,
                        id: null,  // Событие новое, еще нет ИН
                    };
  
                    // if (mode != "create"){
                    //         return alert('Только одно действие!')
                    //     }

                    if (!isAnOverlapEventForAuditorium(newEvent)) {
                        $('#exampleModal').modal('toggle');
                     } else {
                        alert('Нельзя создать событие в выбранное время и аудитории, так как уже существует перекрывающееся событие.');
                    }

                    // mode = "list";

                },
                eventRender: function (event, element, view) {
                    element.bind('contextmenu', function (e) {
                    e.preventDefault();
                    selectedEvent = event;
                    alert(`ПКМ была нажата на событии с ID ${selectedEvent.id}`);
                    // После закрытия alert открываем модальное окно удаления
                    $('#delete-modal').modal('show');
                });


                    element.bind('click', function (e) {
                        if (e.which === 1) {
                            // alert('Левая кнопка мыши сработала!');
                        }
                    });

                    element.hover(
                        function () {
                            $(this).addClass('highlighted-event');
                        },
                        function () {
                            $(this).removeClass('highlighted-event');
                        }
                    );
                },
                eventClick: function (calEvent, jsEvent, view) {
                    $('.highlighted-event.active').removeClass('active');
                    $(this).addClass('active');
                    
                    // Вывод информации о событии
                    alert(`Левая кнопка мыши сработала!\nID: ${calEvent.id}\nStart: ${calEvent.start.format('DD.MM.YYYY HH:mm')}\nEnd: ${calEvent.end.format('DD.MM.YYYY HH:mm')}`);
                },



 

                eventDrop: function (event, delta, revertFunc, jsEvent, ui, view) {
                    const newEvent = {
                        id: event.id,
                        start: event.start.format(),
                        end: event.end.format(),
                        resourceId: event.resourceId,
                    };

                    if (canEventBeResized(newEvent)) {
                        $('.highlighted-event.active').removeClass('active');
                        $(this).addClass('active');
                        
                        // Ваше уведомление
                        alert(`Ивент с ID ${event.id} был перемещен.`);
                    } else {
                        // Revert the event to its original position
                        revertFunc();
                        alert('Нельзя перетаскивать на уже записанное время.');
                    }

                     // обновляем массив событий после перемещения
                    updateEventInArray({
                        id: event.id,
                        start: event.start.format(),
                        end: event.end.format(),
                        resourceId: event.resourceId,
                    });
                },
                eventResize: function (event, delta, revertFunc, jsEvent, ui, view) {
                    const newEvent = {
                        id: event.id,
                        start: event.start.format(),
                        end: event.end.format(),
                        resourceId: event.resourceId,
                    };

                    if (canEventBeResized(newEvent)) {
                        $('.highlighted-event.active').removeClass('active');
                        $(this).addClass('active');
                        
                        // Ваше уведомление
                        alert(`Ивент с ID ${event.id} был изменен по размеру.`);
                    } else {
                        // Revert the event to its original position
                        revertFunc();
                        alert('Нельзя изменять размер на уже записанное время.');
                    }
                    updateEventInArray({
                        id: event.id,
                        start: event.start.format(),
                        end: event.end.format(),
                        resourceId: event.resourceId,
                    });
                },
            });

            document.querySelector('#calendar').addEventListener('mouseleave', function () {
                $('.highlighted-event').removeClass('highlighted-event');
            });



            // СТРЕЛКИ И ПЕРЕМЕЩЕНИЕ НА СЕГОДНЯ

            function arrows() {
                const todayButton = document.querySelector('.fc-today-button');
                const prevButton = document.querySelector('.fc-prev-button');
                const nextButton = document.querySelector('.fc-next-button');

                todayButton.addEventListener('click', function () {
                    const currentDate = $('#calendar').fullCalendar('getDate');
                    alert('Вы вернулись на дату ' + currentDate.format('DD.MM.YYYY'));
                });

                prevButton.addEventListener('click', function () {
                    const currentDate = $('#calendar').fullCalendar('getDate');
                    alert('Вы перешли на дату ' + currentDate.format('DD.MM.YYYY'));
                });

                nextButton.addEventListener('click', function () {
                    const currentDate = $('#calendar').fullCalendar('getDate');
                    alert('Вы перешли на дату ' + currentDate.format('DD.MM.YYYY'));
                });
            }

            arrows();

  
                // Инициализация перетаскивания и изменения размера блока подсказки
                $("#tooltip").draggable();//можем впихнуть это, для изменения развера  .resizable()

                // Добавляем обработчики событий для кнопок сворачивания и закрытия
             

                $('.close-btn').click(function () {
                    $('#tooltip').hide();
                });

                $('.collapse-btn').click(function () {
                    $('.svernisnahyi').toggle();
                });
 
            // переход по ссылке к нужному ивенту     <a href="#?date=2024-01-13&eventId=1">Перейти к событию 2</a>
 
                    $(document).ready(function () {

                        function getUrlParams() {
                            const params = {};
                            window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
                                params[key] = value;
                            });
                            return params;
                        }

                        function scrollToAnchor() {
                            var params = getUrlParams();
                            var dateParam = params['date'];
                            var eventIdParam = params['eventId'];

                            if (dateParam) {
                                var date = moment(dateParam, "YYYY-MM-DD", true);
                                if (date.isValid()) {
                                    $("#calendar").fullCalendar("gotoDate", date.toDate());

                                    if (eventIdParam) {
                                        var matchingEvent = calendarEvents.find(function (event) {
                                            return (
                                                moment(event.start).isSame(date, "day") &&
                                                event.id === eventIdParam
                                            );
                                        });

                                        if (matchingEvent) {
                                            console.log("Found matching event:", matchingEvent);
                                            // Do something with the matching event, e.g., highlight it
                                            $('#calendar').fullCalendar('clientEvents', eventIdParam).forEach(event => {
                                                event.className = (event.className || []).concat('active');
                                                $(event.el).addClass('active');
                                            });
                                        }
                                    }
                                }
                            }
                        }

                        scrollToAnchor();
                        

                    });



                    // Переходим к указанной дате
                // var targetDate = '2024-01-01';
                // calendar.fullCalendar('gotoDate', targetDate);

                // сделали див с классом
                const tooltipButtonRight = document.createElement("div");
                tooltipButtonRight.classList.add('tooltipRight');

                // Создаем новый элемент button
                const helpButton = document.createElement('button');
                helpButton.textContent = '?';
                helpButton.classList.add('helpButton');
                // helpButton.classList.add('helpButton');
                helpButton.classList.add('fc-state-default');

                // Добавляем h1 к div с классом tooltipRight
                tooltipButtonRight.appendChild(helpButton);

                // Находим существующий элемент с классом 'fc-right'
                const fcRightEl = document.querySelector('.fc-right');

                // Добавляем div с классом tooltipRight к элементу с классом 'h1class'
                fcRightEl.appendChild(helpButton);

                const windowHelp = document.querySelector('#tooltip');


                helpButton.addEventListener('click', ()=>{
                    windowHelp.style.display = 'block';
                })                                        
       
                const fcToday = document.querySelector('.fc-today-button').textContent = 'Сегодня';
                // const timelineDay = document.querySelector('.fc-timelineDay-button').textContent = 'День';

 
        });

  
    </script>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Создать событие</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="inputName" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" id="closebtn" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" id="savebtn" class="btn btn-primary">Сохранить настройки</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="delete-modal" tabindex="-1" role="dialog" aria-labelledby="delete-modal-title"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="delete-modal-title">Что хотите сделать с записью?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-footer border-0" style="display: flex;">
                    <button type="button" class="btn btn-danger rounded-lg" id="delete-button"
                        style="flex: 1;">Удалить</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

